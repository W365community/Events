#Connect to CloudPC Graph
$CloudTestAppID = '7649c0f4-b00f-43cb-a1fc-a27b641f5395'
$CloudTestSecretValue = '.go8Q~mIcfzWAb4RYdVtr-~vv6MKQjb3i-~iNbsA'
$TenantId = '075c4074-0ff3-4ceb-958d-467fd274763a'

#Install MSAL.PS module for all users (requires admin rights)
#Install-Module MSAL.PS -Force
If(get-InstalledModule MSal.ps)
{
    write-host "MSAL.ps is already installed"
}Else 
{
    Install-Module MSAL.PS -Force
}
Import-Module -Name MSal.ps -Global -Force
$modules = @("Microsoft.Graph.Users.Actions",
                "Microsoft.Graph.Groups",
                "Microsoft.Graph.DeviceManagement.Administration",
                "Microsoft.Graph.DeviceManagement.Actions" 
            )

foreach ($Module in $modules)
{
    If(Get-InstalledModule -Name $Module)
    {
        Write-Output "$module is already installed"
    }else{
        Install-Module -Name $Module -Force
    }
}

Import-Module -Name $modules -Scope Global -Force

#Sign in to graph
$Token = Get-MsalToken -TenantId $TenantId -ClientId $CloudTestAppID  -ClientSecret ($CloudTestSecretValue | ConvertTo-SecureString -AsPlainText -Force)
#Connect to Graph using access token
Connect-Graph -AccessToken $Token.AccessToken
Select-MgProfile -Name beta

